<IfModule mod_headers.c>
    <FilesMatch "\.php$">
        Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header always set Pragma "no-cache"
        Header always set Expires "Sat, 26 Jul 1997 05:00:00 GMT"
    </FilesMatch>
</IfModule>

# Ensure PHP auto-prepends our back-button/navigation guard for all scripts
<IfModule mod_php7.c>
    php_value auto_prepend_file "includes/auto_back_exit.php"
</IfModule>
<IfModule mod_php8.c>
    php_value auto_prepend_file "includes/auto_back_exit.php"
</IfModule>

# Fallback using environment variable for FPM/CGI if needed
<IfModule mod_env.c>
    SetEnvIfNoCase Request_URI \.php$ NO_CACHE_CONTROL=1
</IfModule>
# Increase upload limits for 3D model files
php_value upload_max_filesize 100M
php_value post_max_size 200M
php_value max_execution_time 600
php_value max_input_time 600
php_value memory_limit 512M

# Enable file uploads
php_flag file_uploads On

# Set maximum number of files that can be uploaded
php_value max_file_uploads 20

# Note: auto_back_exit.php is already auto-prepended above (line 11), so no need to append it again

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Content Security Policy - adjust as needed for your application
# Note: This is a basic CSP. You may need to adjust it based on your specific needs
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none';"

# (Removed) central Cache-Control block for back-button; handled by exit script

# Allow CORS for API endpoints
<Files "*.php">
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</Files>

# Allow CORS for GLB/GLTF static assets and set correct MIME types
<FilesMatch "\.(glb|gltf)$">
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type"
    AddType model/gltf-binary .glb
    AddType model/gltf+json .gltf
</FilesMatch>